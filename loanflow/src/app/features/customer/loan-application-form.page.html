<ion-content [fullscreen]="true" class="main-content">
  <!-- Fixed Top Bar -->
  <div class="fixed-top-bar">
    <div class="top-bar-content">
      <div class="top-bar-left">
        <span  class="emoji-icon app-icon">üí≥</span>
        <span class="app-title">Apply for Loan</span>
      </div>
      
      <div class="top-bar-right">
        <app-header-utils />
      </div>
    </div>
  </div>

  <!-- Content Container with Padding -->
  <div class="application-form-container">
  
  @if (loading()) {
    <div class="loading-container">
      <ion-spinner name="crescent"></ion-spinner>
      <p>Loading product details...</p>
    </div>
  } @else if (product()) {
    <!-- Product Summary -->
    <ion-card class="product-summary">
      <ion-card-content>
        <div class="product-headline">
          <div class="headline-main">
            <span  class="emoji-icon product-icon">üíº</span>
            <div class="headline-text">
              <h3>{{ product()!.name }}</h3>
              @if (product()!.features.length > 0) {
                <p>{{ product()!.features[0] }}</p>
              }
            </div>
          </div>
          <span class="product-chip">
            {{ product()!.loanTermType === 'fixed' ? 'Fixed Term' : 'Flexible Term' }}
          </span>
        </div>

        <div class="product-highlights">
          <div class="highlight-chip">
            <span  class="emoji-icon chip-icon">üí∞</span>
            <span class="chip-text">‚Ç±{{ formatCurrency(product()!.minAmount) }} - ‚Ç±{{ formatCurrency(product()!.maxAmount) }}</span>
          </div>
          <div class="highlight-chip">
            <span  class="emoji-icon chip-icon">üìà</span>
            <span class="chip-text">{{ product()!.interestRate }}% monthly</span>
          </div>
          <div class="highlight-chip">
            <span  class="emoji-icon chip-icon">‚è∞</span>
            <span class="chip-text">
              @if (product()!.loanTermType === 'fixed') {
                {{ Math.round((product()!.fixedTermDays || 90) / 30) }} month term
              } @else {
                {{ Math.round(product()!.minTerm / 30) }}-{{ Math.round(product()!.maxTerm / 30) }} months
              }
            </span>
          </div>
          @if (product()!.paymentFrequency) {
            <div class="highlight-chip">
              <span  class="emoji-icon chip-icon">üìÖ</span>
              <span class="chip-text">{{ getPaymentFrequencyDisplay() }} payments</span>
            </div>
          }
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Application Form -->
    <ion-card class="application-form">
      <ion-card-header>
        <ion-card-title>
          <span  class="emoji-icon title-icon">üìã</span>
          Loan Details
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <!-- Amount Slider -->
        <div class="form-section">
          <ion-label class="section-label">
          <span  class="emoji-icon label-icon">üí∞</span>
          <span class="label-text">Requested Amount</span>
          </ion-label>
          <div class="amount-display">
            ‚Ç±{{ formatCurrency(requestedAmount()) }}
          </div>
          <ion-range
            [min]="product()!.minAmount"
            [max]="product()!.maxAmount"
            [step]="100"
            [value]="requestedAmount()"
            (ionChange)="onAmountChange($event)"
            [pin]="true"
            [pinFormatter]="formatCurrency"
          >
            <ion-label slot="start">‚Ç±{{ formatCurrency(product()!.minAmount) }}</ion-label>
            <ion-label slot="end">‚Ç±{{ formatCurrency(product()!.maxAmount) }}</ion-label>
          </ion-range>
        </div>

        <!-- Term Slider -->
        <div class="form-section">
          <ion-label class="section-label">
            <span  class="emoji-icon label-icon">üìÖ</span>
            <span class="label-text">Loan Term</span>
            @if (product()!.loanTermType === 'fixed') {<span class="fixed-badge"><span  class="emoji-icon">üîí</span> Fixed</span>}
          </ion-label>
          <div class="term-display">
            {{ requestedTermMonths() }} Months
          </div>
          @if (product()!.loanTermType === 'fixed') {
            <!-- Fixed term: Show slider but DISABLED -->
            <ion-range
              [min]="Math.round((product()!.fixedTermDays || 90) / 30)"
              [max]="Math.round((product()!.fixedTermDays || 90) / 30)"
              [step]="1"
              [value]="requestedTermMonths()"
              [disabled]="true"
              [pin]="false"
            >
              <ion-label slot="start">{{ Math.round((product()!.fixedTermDays || 90) / 30) }}m</ion-label>
              <ion-label slot="end">{{ Math.round((product()!.fixedTermDays || 90) / 30) }}m</ion-label>
            </ion-range>
          } @else {
            <!-- Flexible term: Show slider ENABLED -->
            <ion-range
              [min]="Math.round(product()!.minTerm / 30)"
              [max]="Math.round(product()!.maxTerm / 30)"
              [step]="1"
              [value]="requestedTermMonths()"
              (ionChange)="onTermChange($event)"
              [pin]="true"
            >
              <ion-label slot="start">{{ Math.round(product()!.minTerm / 30) }}m</ion-label>
              <ion-label slot="end">{{ Math.round(product()!.maxTerm / 30) }}m</ion-label>
            </ion-range>
          }
        </div>

        <!-- Payment Frequency (Display Only) -->
        <div class="form-section">
          <div class="frequency-row">
            <div class="frequency-left">
              <span  class="emoji-icon label-icon">üìÖ</span>
              <span class="label-text">Payment Frequency</span>
            </div>
            <div class="frequency-value">
              {{ getPaymentFrequencyDisplay() }}
            </div>
          </div>
          <p class="frequency-note">Payment frequency is set by the loan product</p>
        </div>

        <!-- Purpose -->
        <div class="form-section">
          <ion-item lines="none">
            <ion-label position="stacked">
                <span  class="emoji-icon label-icon">üìÑ</span>
                <span class="label-text">Purpose (Optional)</span>
            </ion-label>
            <ion-textarea
              placeholder="E.g., Business expansion, Medical expenses, etc."
              rows="3"
              [(ngModel)]="purpose"
            ></ion-textarea>
          </ion-item>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Repayment Summary -->
    <ion-card class="repayment-summary">
      <ion-card-header>
        <ion-card-title>
          <span  class="emoji-icon summary-title-icon">üìä</span>
          Payment Summary
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <div class="basic-charges">
          <div class="summary-line">
            <span class="summary-label">Loan Amount</span>
            <span class="summary-value">‚Ç±{{ formatCurrency(requestedAmount()) }}</span>
          </div>
          @if (product()!.processingFee > 0 && product()!.deductProcessingFeeInAdvance) {
            <div class="summary-line negative">
              <span class="summary-label">Processing Fee ({{ product()!.processingFee }}%)</span>
              <span class="summary-value">-‚Ç±{{ formatCurrency(getProcessingFeeAmount()) }}</span>
            </div>
          }
          @if (hasPlatformFee() && product()!.deductPlatformFeeInAdvance) {
            <div class="summary-line negative">
              <span class="summary-label">Platform Fee (per month)</span>
              <span class="summary-value">-‚Ç±{{ formatCurrency(getPlatformFee()) }}</span>
            </div>
          }
          @if (getTotalInterest() > 0 && product()!.deductInterestInAdvance) {
            <div class="summary-line negative">
              <span class="summary-label">Interest ({{ product()!.interestRate }}%)</span>
              <span class="summary-value">-‚Ç±{{ formatCurrency(getTotalInterest()) }}</span>
            </div>
          }
        </div>

        <div class="net-row">
          <div class="net-left">
            <span  class="emoji-icon net-icon">üëõ</span>
            <div class="net-text">
              <p class="net-label">Net Received</p>
              <p class="net-subtitle">Amount disbursed after fees</p>
            </div>
          </div>
          <span class="net-value">‚Ç±{{ formatCurrency(getNetReceived()) }}</span>
        </div>

        <div class="interest-row">
          <div class="interest-item">
            <p class="interest-label">Interest Rate</p>
            <p class="interest-value">{{ product()!.interestRate }}% ({{ getInterestLabel() }})</p>
          </div>
          <div class="interest-item">
            <p class="interest-label">Total Interest @if (product()!.deductInterestInAdvance) {<span class="interest-badge">Upfront</span>}</p>
            <p class="interest-value">‚Ç±{{ formatCurrency(getTotalInterest()) }}</p>
          </div>
        </div>

        <div class="totals-panel">
          <div class="total-card primary">
            <p class="total-label">Total Repayment</p>
            <p class="total-value">‚Ç±{{ formatCurrency(getTotalRepayment()) }}</p>
          </div>
          <div class="total-card secondary">
            <p class="total-label">{{ getPaymentLabel() }} Payment</p>
            <p class="total-value">‚Ç±{{ formatCurrency(getInstallmentAmount()) }}</p>
          </div>
        </div>

        <div class="payment-schedule">
          <span>{{ formatNumber(getPaymentCount()) }} {{ getPaymentFrequencyDisplay().toLowerCase() }} payments</span>
          <span class="separator">‚Ä¢</span>
          <span>{{ requestedTermMonths() }} {{ requestedTermMonths() === 1 ? 'month' : 'months' }}</span>
        </div>

        <div class="summary-note">
          <span  class="emoji-icon note-icon">‚ÑπÔ∏è</span>
          <div class="note-text">
            <p>Fees shown above will be deducted from the loan amount before disbursement. Net Received shows what you'll actually get. This is an estimate - actual terms may vary. Late payments may incur penalties.</p>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Submit Button -->
    <ion-button
      expand="block"
      size="large"
      class="submit-button"
      (click)="submitApplication()"
      [disabled]="submitting()"
    >
      <span slot="start"  class="emoji-icon">‚úÖ</span>
      {{ submitting() ? 'Submitting...' : 'Submit Application' }}
    </ion-button>
    
    <!-- Back Button -->
    <button class="back-bottom-button" (click)="goBack()">
      <span  class="emoji-icon">‚¨ÖÔ∏è</span>
      Back to Products
    </button>
  }
  </div>
</ion-content>
