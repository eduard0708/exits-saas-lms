<ion-content [fullscreen]="true" class="main-content">
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- Fixed Top Bar -->
  <div class="fixed-top-bar">
    <div class="top-bar-content">
      <div class="top-bar-left">
        <span class="app-emoji">ğŸ’³</span>
        <span class="app-title">Payment History</span>
      </div>
      
      <div class="top-bar-right">
        <app-header-utils />
      </div>
    </div>
  </div>

  <!-- Content Container with Padding -->
  <div class="payments-container">
  <!-- Summary Card -->
  <ion-card class="summary-card">
    <ion-card-content>
      <div class="summary-content">
        <div class="summary-item">
          <ion-label class="summary-label">Total Payments</ion-label>
          <div class="summary-value">{{ payments.length }}</div>
        </div>
        <div class="summary-divider"></div>
        <div class="summary-item">
          <ion-label class="summary-label">Total Amount Paid</ion-label>
          <div class="summary-value primary">{{ formatCurrency(totalPaid) }}</div>
        </div>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Filter Segment -->
  <ion-card class="filter-card">
    <ion-card-content>
      <ion-segment [value]="selectedFilter" (ionChange)="onFilterChange($event)">
        <ion-segment-button value="all">
          <ion-label>All</ion-label>
        </ion-segment-button>
        <ion-segment-button value="completed">
          <ion-label>Completed</ion-label>
        </ion-segment-button>
        <ion-segment-button value="pending">
          <ion-label>Pending</ion-label>
        </ion-segment-button>
      </ion-segment>
    </ion-card-content>
  </ion-card>

  <!-- Loading Spinner -->
  @if (loading) {
    <div class="loading-container">
      <ion-spinner name="crescent"></ion-spinner>
      <p>Loading payments...</p>
    </div>
  }

  <!-- Empty State -->
  @if (!loading && filteredPayments.length === 0) {
    <div class="empty-state">
      <div class="empty-hero">
        <span class="empty-emoji">ğŸ’¸</span>
      </div>
      <h2 class="empty-title">No payments here yet</h2>
      @if (selectedFilter === 'all') {
        <p class="empty-message">
          Once you complete your first repayment, the full history will appear here for easy tracking.
        </p>
      } @else {
        <p class="empty-message">
          We could not find any {{ selectedFilter }} payments. Try another filter or refresh to check for recent activity.
        </p>
      }
      <div class="empty-hint">
        <span  class="emoji-icon">â°</span>
        <span>Payments sync in real time after every transaction.</span>
      </div>
      <div class="empty-actions">
        <ion-button size="small" class="empty-refresh" (click)="refreshPayments()" [disabled]="loading">
          <span slot="start"  class="emoji-icon">ğŸ”„</span>
          Refresh payments
        </ion-button>
        <button type="button" class="empty-secondary" (click)="goToDashboard()">
          Back to dashboard
        </button>
      </div>
    </div>
  }

  <!-- Payment List -->
  @if (!loading && filteredPayments.length > 0) {
    <ion-list>
      @for (payment of filteredPayments; track payment.id) {
        <ion-card class="payment-card">
          <ion-card-header>
            <div class="payment-header">
              <div class="payment-header-left">
                <span  class="emoji-icon payment-icon">{{ getPaymentMethodEmoji(payment.paymentMethod) }}</span>
                <div class="payment-info">
                  <ion-card-title class="payment-amount">
                    {{ formatCurrency(payment.amount) }}
                  </ion-card-title>
                  <ion-note class="payment-reference">{{ payment.paymentReference }}</ion-note>
                </div>
              </div>
              <ion-badge [color]="getStatusColor(payment.status)">
                {{ payment.status }}
              </ion-badge>
            </div>
          </ion-card-header>

          <ion-card-content>
            <!-- Loan Information -->
            <div class="payment-detail-row">
              <span  class="emoji-icon detail-icon">ğŸ§¾</span>
              <div class="detail-content">
                <ion-label class="detail-label">Loan Number</ion-label>
                <ion-note class="detail-value">{{ payment.loanNumber }}</ion-note>
              </div>
            </div>

            <!-- Payment Method -->
            <div class="payment-detail-row">
              <span  class="emoji-icon detail-icon">{{ getPaymentMethodEmoji(payment.paymentMethod) }}</span>
              <div class="detail-content">
                <ion-label class="detail-label">Payment Method</ion-label>
                <ion-note class="detail-value">{{ getPaymentMethodLabel(payment.paymentMethod) }}</ion-note>
              </div>
            </div>

            <!-- Payment Date -->
            <div class="payment-detail-row">
              <span  class="emoji-icon detail-icon">ğŸ“…</span>
              <div class="detail-content">
                <ion-label class="detail-label">Payment Date</ion-label>
                <ion-note class="detail-value">
                  {{ formatDate(payment.paymentDate) }} at {{ formatTime(payment.createdAt) }}
                </ion-note>
              </div>
            </div>

            <!-- Amount Breakdown -->
            @if (payment.principalAmount > 0 || payment.interestAmount > 0) {
              <div class="breakdown-section">
                <ion-label class="breakdown-title">Amount Breakdown</ion-label>
                <div class="breakdown-grid">
                  @if (payment.principalAmount > 0) {
                    <div class="breakdown-item">
                      <ion-label class="breakdown-label">Principal</ion-label>
                      <ion-note class="breakdown-value">{{ formatCurrency(payment.principalAmount) }}</ion-note>
                    </div>
                  }
                  @if (payment.interestAmount > 0) {
                    <div class="breakdown-item">
                      <ion-label class="breakdown-label">Interest</ion-label>
                      <ion-note class="breakdown-value">{{ formatCurrency(payment.interestAmount) }}</ion-note>
                    </div>
                  }
                  @if (payment.penaltyAmount > 0) {
                    <div class="breakdown-item">
                      <ion-label class="breakdown-label">Penalty</ion-label>
                      <ion-note class="breakdown-value danger">{{ formatCurrency(payment.penaltyAmount) }}</ion-note>
                    </div>
                  }
                </div>
              </div>
            }

            <!-- Notes -->
            @if (payment.notes) {
              <div class="payment-notes">
                <ion-label class="notes-label">Notes</ion-label>
                <ion-note class="notes-text">{{ payment.notes }}</ion-note>
              </div>
            }
          </ion-card-content>
        </ion-card>
      }
    </ion-list>
  }
  </div>
</ion-content>
